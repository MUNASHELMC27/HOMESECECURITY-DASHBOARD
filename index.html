<script>
  const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

  const gasStatus = document.getElementById('gasStatus');
  const flameStatus = document.getElementById('flameStatus');
  const mqttStatus = document.getElementById('mqttStatus');
  const lastUpdate = document.getElementById('lastUpdate');
  const alertSound = document.getElementById('alertSound');

  const ctx = document.getElementById('hazardChart').getContext('2d');
  const hazardChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Hazard Value',
        data: [],
        fill: false,
        borderColor: '#00bcd4',
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      animation: false,
      scales: {
        x: { title: { display: true, text: 'Time' }},
        y: { beginAtZero: true, title: { display: true, text: 'Value' }}
      }
    }
  });

  client.on('connect', () => {
    console.log('MQTT Connected');
    mqttStatus.innerHTML = 'MQTT: <span class="status-icon">✅</span> Connected';
    client.subscribe('esp32/hazard');
  });

  client.on('error', (err) => {
    mqttStatus.innerHTML = 'MQTT: <span class="status-icon">❌</span> Error';
  });

  client.on('message', (topic, message) => {
    const time = new Date().toLocaleTimeString();
    let value = null;
    let gas = 'safe';
    let flame = 'none';

    try {
      const data = JSON.parse(message.toString());
      value = parseFloat(data.value);
      gas = data.gas || 'safe';
      flame = data.flame || 'none';
    } catch (err) {
      // Not JSON, assume raw value
      value = parseFloat(message.toString());
    }

    if (!isNaN(value)) {
      hazardChart.data.labels.push(time);
      hazardChart.data.datasets[0].data.push(value);

      if (hazardChart.data.labels.length > 20) {
        hazardChart.data.labels.shift();
        hazardChart.data.datasets[0].data.shift();
      }
      hazardChart.update();

      updateStatus(gas, flame, time);
    }
  });

  function updateStatus(gas, flame, time) {
    // GAS
    if (gas === 'danger') {
      gasStatus.innerHTML = 'Gas Sensor: <span class="status-icon">❌</span> Dangerous!';
      gasStatus.classList.add('alert');
      alertSound.play();
    } else {
      gasStatus.innerHTML = 'Gas Sensor: <span class="status-icon">✅</span> Safe';
      gasStatus.classList.remove('alert');
    }

    // FLAME
    if (flame === 'detected') {
      flameStatus.innerHTML = 'Flame Sensor: <span class="status-icon">❌</span> Flame Detected!';
      flameStatus.classList.add('alert');
      alertSound.play();
    } else {
      flameStatus.innerHTML = 'Flame Sensor: <span class="status-icon">✅</span> No flame detected';
      flameStatus.classList.remove('alert');
    }

    lastUpdate.textContent = `Last update: ${time}`;
  }
</script>
